@page "/enrollments/edit/{EnrollmentId:int}"
@inject StudentCourseApp.Services.EnrollmentService EnrollmentService
@inject NavigationManager Navigation

<h3>Edit Enrollment</h3>

@if (enrollment == null)
{
    <div class="alert alert-info">Loading enrollment...</div>
}
else
{
    <div class="card shadow-sm p-3 mb-3" style="max-width:500px">
        <h5>@enrollment.Student.Name - @enrollment.Course.Title</h5>

        <div class="mb-3">
            <label class="form-label fw-bold">Percentage</label>
        <input type="number" 
               class="form-control" 
               min="0" max="100"
               @bind-value="percentage" 
               @bind-value:event="oninput" />
        </div>

        <div class="mb-3">
            <label class="form-label fw-bold">Letter Grade</label>
            <input class="form-control" value="@LetterGrade" readonly />
        </div>

        <button class="btn btn-success me-2" @onclick="SaveChanges">Save</button>
        <button class="btn btn-secondary" @onclick="Cancel">Cancel</button>
    </div>
}

@code {
    [Parameter]
    public int EnrollmentId { get; set; } // MUST match the route placeholder

    private StudentCourseApp.Models.Enrollment enrollment;
    private decimal percentage;
    private string letterGrade;

    protected override async Task OnInitializedAsync()
    {
        var allEnrollments = await EnrollmentService.GetActiveEnrollments();
        enrollment = allEnrollments.FirstOrDefault(e => e.Id == EnrollmentId);

        if (enrollment != null)
        {
            percentage = enrollment.Percentage;
            letterGrade = enrollment.Grade;
        }
    }

    private string LetterGrade => percentage switch
    {
        >= 80 => "A",
        >= 70 => "B",
        >= 60 => "C",
        >= 50 => "D",
        _ => "F"
    };


    private async Task SaveChanges()
    {
        if (enrollment != null)
        {
            enrollment.Percentage = percentage;
            enrollment.Grade = letterGrade;
            await EnrollmentService.ChangeGrade(enrollment.Id, letterGrade, percentage);
            Navigation.NavigateTo("/enrollments");
        }
    }

    private void Cancel() => Navigation.NavigateTo("/enrollments");
}
